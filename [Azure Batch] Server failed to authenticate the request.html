<html><head>
<meta charset='UTF-8'>
<link href='resource/bootstrap.min.css' rel='Stylesheet' type='text/css' />
<link href='resource/style.css' rel='Stylesheet' type='text/css' />
</head>
<body>
<div id='page'>
<h1 class='entry-title'>[Azure Batch] Server failed to authenticate the request</h1>
 <a class='url fn n profile-usercard-hover' href='https://social.msdn.microsoft.com/profile/Maheshk [MSFT]' target='_blank'>Maheshk [MSFT]</a>
<time>    12/20/2016 3:42:00 AM</time>
<hr>
<div id='content'><p>Today happen to work on this problem, where developer running unit test code creating Azure Batch Jobs in row and check the status in a tight loop getting forbidden error. Interestingly, it worked for him for the first couple of calls “job” creation but fails continuously after that in row. Grabbed the the fiddler log to see the request and response and noticed something as like below.&nbsp; </p> <p><font style="background-color: #ffff00"><strong>Fiddler trace:</strong></font> </p> <blockquote> <p><font color="#c0504d" size="2" face="Consolas"><font color="#c0504d" size="2" face="Consolas">HTTP/1.1 403 Server failed to authenticate the request. Make sure the value of Authorization header is formed correctly including the signature.</font></font>  <p><font color="#c0504d" size="2" face="Consolas">Content-Length: 864</font>  <p><font color="#c0504d" size="2" face="Consolas">Content-Type: application/json;odata=minimalmetadata</font>  <p><font color="#c0504d" size="2" face="Consolas">Server: Microsoft-HTTPAPI/2.0</font>  <p><font color="#c0504d" size="2" face="Consolas">request-id: fd81d621-xxxxx-b252-1db46324f1a6</font>  <p><font color="#c0504d" size="2" face="Consolas">Strict-Transport-Security: max-age=31536000; includeSubDomains</font>  <p><font color="#c0504d" size="2" face="Consolas">X-Content-Type-Options: nosniff</font>  <p><font color="#c0504d" size="2" face="Consolas">DataServiceVersion: 3.0</font>  <p><font color="#c0504d" size="2" face="Consolas">Date: Tue, 13 Dec 2016 15:51:34 GMT</font>  <p><font color="#c0504d" size="2" face="Consolas">Cache-Control: proxy-revalidate</font>  <p><font color="#c0504d" size="2" face="Consolas">Proxy-Connection: Keep-Alive</font>  <p><font color="#c0504d" size="2" face="Consolas">Connection: Keep-Alive</font>  <p><font color="#c0504d" size="2" face="Consolas">{</font>  <p><font color="#c0504d" size="2" face="Consolas">&nbsp; "odata.metadata":"</font><a href="https://xxxxxx.eastus2.batch.azure.com/$metadata#Microsoft.Azure.Batch.Protocol.Entities.Container.errors/@Element"><font color="#c0504d" size="2" face="Consolas">https://xxxxxx.eastus2.batch.azure.com/$metadata#Microsoft.Azure.Batch.Protocol.Entities.Container.errors/@Element</font></a><font color="#c0504d" size="2" face="Consolas">","code":"AuthenticationFailed","message":{</font>  <p><font color="#c0504d" size="2" face="Consolas">&nbsp;&nbsp;&nbsp; "lang":"en-US","value<font style="background-color: #ffff00">":"Server failed to authenticate the request. Make sure the value of Authorization header is formed correctly including the signature.\nRequestId:xxxxx-564c-4930-xxx-xxx\nTime:2016-12-13T15:51:34.2917937Z"</font></font>  <p><font color="#c0504d" size="2" face="Consolas">&nbsp; },"values":[</font>  <p><font color="#c0504d" size="2" face="Consolas">&nbsp;&nbsp;&nbsp; {</font>  <p><font color="#c0504d" size="2" face="Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "key":"<font style="background-color: #ffff00"><strong>AuthenticationErrorDetail</strong></font>","value<font style="background-color: #ffff00">":"The MAC signature found in the HTTP request '6nxk/xxxxxx/xmdrWt55RnMRmsg=' is not the same as any computed signature. Server used following string to sign: 'GET\n\n\n\n\n\n\nTue, 13 Dec 2016 15:42:18 GMT\n\n0x8D4236E9EB80606\n\n\nocp-date:Tue, 13 Dec 2016 15:51:35 GMT\n/xxxxx/jobs/deleteJob0\napi-version:2016-07-01.3.1'."</font></font>  <p><font color="#c0504d" size="2" face="Consolas">&nbsp;&nbsp;&nbsp; }</font>  <p><font color="#c0504d" size="2" face="Consolas">&nbsp; ]</font>  <p><font color="#c0504d" size="2" face="Consolas">}</font><font color="#c0504d" size="2" face="Consolas"></font></p></blockquote> <p><strong><font style="background-color: #ffff00">Findings:</font> </strong> <p>This appears to be some kind of caching - <a href="https://social.msdn.microsoft.com/Forums/SqlServer/en-US/67183d62-60ab-4ef0-a1ca-b765d85ea2f6/authenticationfailed?forum=azurebatch">https://social.msdn.microsoft.com/Forums/SqlServer/en-US/67183d62-60ab-4ef0-a1ca-b765d85ea2f6/authenticationfailed?forum=azurebatch</a>.&nbsp; It is caused by client-side caching at the proxy layer. Usually the proxy server at client side caches the get responses and for subsequent gets proxy server will try to serve the request from its cache. It sends a different request to server by adding If-Match header with the ETag. However, this causes a problem in this case because the proxy server does not change the Authorization header, it uses the same Auth header that client sends. Hence, the auth header that client sends does not match what server expects.  <p><strong><font style="background-color: #ffff00">Fix:&nbsp; </font></strong> <p>Added the below config value to <em>App.Config</em> file which resolved this issue. He was able to continue execute his test harness by submitting/deleting 10 jobs successfully without caching issues.  <blockquote> <p align="justify"><font color="#c0504d" size="3" face="Courier New"><strong><font color="#c0504d" size="3" face="Courier New"><strong><font color="#c0504d" size="3" face="Courier New"><strong><font color="#c0504d" size="3" face="Courier New"><strong>&lt;system.net&gt;</strong></font></strong></font></strong></font></strong></font></p> <p align="justify"><font size="3" face="Courier New"><strong>&nbsp;&nbsp;&nbsp; <font color="#c0504d">&lt;requestCaching</font> <font color="#ff0000">defaultPolicyLevel</font>="<font color="#0000ff">NoCacheNoStore</font><font color="#0000ff">"/&gt;</font></strong></font><font size="3" face="Courier New"><strong><font color="#0000ff"></font></strong></font><font size="3" face="Courier New"><strong><font color="#0000ff"></font></strong></font></p></blockquote> <p><font color="#000000" size="2">Hope this helps. </font></p></div>
</div></body>
<script type='text/javascript' src='resource/jquery-1.12.1.min.js'></script>
<script type='text/javascript' src='resource/replace.js'></script>
</html>
