<html><head>
<meta charset='UTF-8'>
<link href='resource/bootstrap.min.css' rel='Stylesheet' type='text/css' />
<link href='resource/style.css' rel='Stylesheet' type='text/css' />
</head>
<body>
<div id='page'>
<h1 class='entry-title'>[Service Fabric] How to Secure a standalone cluster (On Prem)</h1>
 <a class='url fn n profile-usercard-hover' href='https://social.msdn.microsoft.com/profile/Maheshk [MSFT]' target='_blank'>Maheshk [MSFT]</a>
<time>    1/27/2017 6:54:00 AM</time>
<hr>
<div id='content'><p><font size="2"><font size="2">This blog post is based on this article -</font></font><font size="2"><font size="2"><a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server;"><font size="2"><a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server"><font size="2">https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server</font></a></font>;</a> I ran into issue, so would like to break into step by step for easier reference along with precautions. </font></font> <p><font size="2">Step 1 and 2 objective is same. All we need here is, just make sure to have NETWORK SERVICE added and have permission set. </font> <p><font size="2">1) Install the certificate in server node :-&nbsp; Console Root &gt; Local Computer &gt; Personal &gt; Certificates &gt; install at this level and hit refresh to confirm</font>  <p><a href="media/2017/01/clip_image0013.gif"><img title="clip_image001" alt="clip_image001" src="media/2017/01/clip_image001_thumb2.gif" width="867" height="323"></a> <p><a href="media/2017/01/clip_image0022.gif"><img title="clip_image002" alt="clip_image002" src="media/2017/01/clip_image002_thumb2.gif" width="757" height="470"></a> <p><font size="2">Once after the installation, right click the cert &gt; All tasks &gt; Manage private keys &gt; Add NETWORK SERVICE and provide the default permission as it is and save. we should see “Allow” for Full control &amp; Read permission. </font> <p><font size="2">2) Alternatively you could also achieve the same using PS. Open the PS ISE window, run the below PS in Admin mode to make this update. </font><font size="2">This step is optional if you have already performed the step #1 manually. </font> <blockquote> <p><font color="#0000ff" size="1" face="Consolas">param</font> <p><font color="#0000ff" size="1" face="Consolas">(</font> <p><font color="#0000ff" size="1" face="Consolas">[Parameter(Position=1, Mandatory=$true)]</font> <p><font color="#0000ff" size="1" face="Consolas">[ValidateNotNullOrEmpty()]</font> <p><font color="#0000ff" size="1" face="Consolas">[string]$pfxThumbPrint,</font> <p><font color="#0000ff" size="1" face="Consolas">[Parameter(Position=2, Mandatory=$true)]</font> <p><font color="#0000ff" size="1" face="Consolas">[ValidateNotNullOrEmpty()]</font> <p><font color="#0000ff" size="1" face="Consolas">[string]$serviceAccount</font> <p><font color="#0000ff" size="1" face="Consolas">)</font> <p><font color="#0000ff" size="1" face="Consolas">$cert = Get-ChildItem -Path cert:\LocalMachine\My | Where-Object -FilterScript { $PSItem.ThumbPrint -eq $pfxThumbPrint; }</font> <p><font color="#0000ff" size="1" face="Consolas"># Specify the user, the permissions and the permission type</font> <p><font color="#0000ff" size="1" face="Consolas">$permission = "$($serviceAccount)","FullControl","Allow"</font> <p><font color="#0000ff" size="1" face="Consolas">$accessRule = New-Object -TypeName System.Security.AccessControl.FileSystemAccessRule -ArgumentList $permission</font> <p><font color="#0000ff" size="1" face="Consolas"># Location of the machine related keys</font> <p><font color="#0000ff" size="1" face="Consolas">$keyPath = Join-Path -Path $env:ProgramData -ChildPath "\Microsoft\Crypto\RSA\MachineKeys"</font> <p><font color="#0000ff" size="1" face="Consolas">$keyName = $cert.PrivateKey.CspKeyContainerInfo.UniqueKeyContainerName</font> <p><font color="#0000ff" size="1" face="Consolas">$keyFullPath = Join-Path -Path $keyPath -ChildPath $keyName</font> <p><font color="#0000ff" size="1" face="Consolas"># Get the current acl of the private key</font> <p><font color="#0000ff" size="1" face="Consolas">$acl = (Get-Item $keyFullPath).GetAccessControl('Access')</font> <p><font color="#0000ff" size="1" face="Consolas"># Add the new ace to the acl of the private key</font> <p><font color="#0000ff" size="1" face="Consolas">$acl.SetAccessRule($accessRule)</font> <p><font color="#0000ff" size="1" face="Consolas"># Write back the new acl</font> <p><font color="#0000ff" size="1" face="Consolas">Set-Acl -Path $keyFullPath -AclObject $acl -ErrorAction Stop</font> <p><font color="#0000ff" size="1" face="Consolas"># Observe the access rights currently assigned to this certificate.</font> <p><font color="#0000ff" size="1" face="Consolas">get-acl $keyFullPath| fl</font><font color="#c0504d"></font><font color="#c0504d"></font><font color="#c0504d"></font><font color="#c0504d"></font></p></blockquote> <p><font size="2">----------------------</font> <p><font size="2"><strong>Parameter:-</strong> </font> <p><font size="2"> On execution, enter your cert thumbprint and service account details as below. </font> <p><font size="2">pfxThumbPrint: AA4E00A783B246D53A88433xxxx55F493AC6D7 </font> <p><font size="2">serviceAccount: NETWORK SERVICE </font> <p><font size="2"><strong>Output:-</strong> </font> <p align="justify"><font color="#0000ff" size="1" face="Consolas">Path&nbsp;&nbsp; : Microsoft.PowerShell.Core\FileSystem::C:\ProgramData\Microsoft\Crypto\RSA\MachineKeys\</font> <p align="justify"><font color="#0000ff" size="1" face="Consolas">Owner&nbsp; : NT AUTHORITY\SYSTEM</font> <p align="justify"><font color="#0000ff" size="1" face="Consolas">Group&nbsp; : NT AUTHORITY\SYSTEM</font> <p align="justify"><font color="#0000ff" size="1" face="Consolas">Access : Everyone Allow&nbsp; Write, Read, Synchronize</font> <p align="justify"><font color="#0000ff" size="1" face="Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NT AUTHORITY\NETWORK SERVICE Allow&nbsp; FullControl</font> <p align="justify"><font color="#0000ff" size="1" face="Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BUILTIN\Administrators Allow&nbsp; FullControl</font> <p align="justify"><font color="#0000ff" size="1" face="Consolas">Audit&nbsp; : </font> <p align="justify"><font color="#0000ff" size="1" face="Consolas">Sddl&nbsp;&nbsp; : O:SYG:SYD:PAI(A;;0x12019f;;;WD)(A;;FA;;;NS)(A;;FA;;;BA)</font><font face="Candara"></font><font face="Candara"></font><font face="Candara"></font> <p><font size="2">3) Step (1 or 2) is the only change required at Server side for certificate. </font> <p><font size="2">Now start downloading &gt; "Download the Service Fabric standalone package" </font><a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server"><font size="2">https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server</font></a><font size="2"> and extract say C:\WindowsServiceFabricCluster\</font> <p><font size="2">4) Pick this template <font style="background-color: #ffff00">"ClusterConfig.X509.DevCluster"</font> json template file and update with your thumbprint and save it. </font> <p><font size="2">Ps:- I have removed secondary certificate and proxy certificate section for simplicity</font> <p><font size="2">&nbsp;<font color="#c0504d" face="Courier New">&nbsp; "security": {</font></font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "metadata": "The Credential type X509 indicates this is cluster is secured using X509 Certificates. The thumbprint format is - d5 ec 42 56 b9 d5 31 24 25 42 64.",</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ClusterCredentialType": "X509",</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ServerCredentialType": "X509",</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "CertificateInformation": {</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ClusterCertificate": {</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Thumbprint": "AA4E00A783B246D53Axxxxx3203855F493AC6D7",</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "X509StoreName": "My"</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ServerCertificate": {</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Thumbprint": "AA4E00A783B246D53A8xxxxxx3855F493AC6D7",</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "X509StoreName": "My"</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ClientCertificateThumbprints": [</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "CertificateThumbprint": "AA4E00A783B24xxxxx203855F493AC6D7",</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "IsAdmin": false</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "CertificateThumbprint": "AA4E00A783B246D5xxxxxx203855F493AC6D7",</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "IsAdmin": true</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font> <p><font color="#c0504d" size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },</font> <p><font size="2">5) Now run the PS command let from this directory to create the cluster </font> <p><font size="2" face="Courier New">PS C:\WindowsServiceFabricCluster<strong>&gt;.\CreateServiceFabricCluster.ps1 -ClusterConfigFilePath .\ClusterConfig.X509.DevCluster.json -AcceptEULA</strong></font> <p><font color="#0000ff" size="2" face="Courier New">Creating Service Fabric Cluster...</font> <p><font color="#0000ff" size="2" face="Courier New">If it's taking too long, please check in Task Manager details and see if Fabric.exe for each node is running. If not, please look at: 1. traces in DeploymentTraces directory and 2. traces in FabricLogRoot </font> <p><font color="#0000ff" size="2" face="Courier New">configured in ClusterConfig.json.</font> <p><font color="#0000ff" size="2" face="Courier New">Trace folder already exists. Traces will be written to existing trace folder: C:\temp\Microsoft.Azure.ServiceFabric.WindowsServer\DeploymentTraces</font> <p><font color="#0000ff" size="2" face="Courier New">Running Best Practices Analyzer...</font> <p><font color="#0000ff" size="2" face="Courier New">Best Practices Analyzer completed successfully.</font> <p><font color="#0000ff" size="2" face="Courier New">Creating Service Fabric Cluster...</font> <p><font color="#0000ff" size="2" face="Courier New">Processing and validating cluster config.</font> <p><font color="#0000ff" size="2" face="Courier New">Configuring nodes.</font> <p><font color="#0000ff" size="2" face="Courier New">Default installation directory chosen based on system drive of machine 'localhost'.</font> <p><font color="#0000ff" size="2" face="Courier New">Copying installer to all machines.</font> <p><font color="#0000ff" size="2" face="Courier New">Configuring machine 'localhost'.</font> <p><font color="#0000ff" size="2" face="Courier New">Machine localhost configured.</font> <p><font color="#0000ff" size="2" face="Courier New">Running Fabric service installation.</font> <p><font color="#0000ff" size="2" face="Courier New">Successfully started FabricInstallerSvc on machine localhost</font> <p><font color="#0000ff" size="2" face="Courier New">Successfully started FabricHostSvc on machine localhost</font> <p><font color="#0000ff" size="2" face="Courier New">Your cluster is successfully created! You can connect and manage your cluster using Microsoft Azure Service Fabric Explorer or Powershell. To connect through Powershell, run 'Connect-ServiceFabricCluster [</font> <p><font color="#0000ff" size="2" face="Courier New">ClusterConnectionEndpoint]'.</font> <p><font size="2">6) At this stage, we should see the cluster creation success message with that. We are done with cluster creation and securing them.</font> <p><font size="2">7) Now at client side/end user machine where try to browse the secured cluster over IE, we should see dialog prompt asking for certificate. It means, it is working as expected – so far good. </font> <p><font size="2">8) Now install the client certificate at your client machine. For simplicity sake, I am using the same machine as Client and Server. But certificate has to be installed under Current User when accessing the cluster over IE. </font> <p><font size="2">Certmgr &gt; Current User &gt; Personal &gt; Certificates. </font> <p><a href="media/2017/01/clip_image0032.gif"><font size="2"><a href="media/2017/01/clip_image0033.gif"><img title="clip_image003" alt="clip_image003" src="media/2017/01/clip_image003_thumb1.gif" width="970" height="367"></a></font></a> <p><font size="2">9) Now we are ready to access, browse the cluster url say - </font><a href="https://localhost:19080/"><font size="2">https://localhost:19080/</font></a><font size="2">, we should see a cert selection dialog displayed. </font> <p><a href="media/2017/01/clip_image0042.gif"><font size="2"><a href="media/2017/01/clip_image0043.gif"><img title="clip_image004" alt="clip_image004" src="media/2017/01/clip_image004_thumb1.gif" width="723" height="534"></a></font></a> <p><a href="media/2017/01/clip_image0052.gif"><font size="2"><a href="media/2017/01/clip_image0053.gif"><img title="clip_image005" alt="clip_image005" src="media/2017/01/clip_image005_thumb1.gif" width="757" height="490"></a></font></a> <p><font size="2"></font>&nbsp; <p><font size="2"><strong>How to create self signed certificate (PFX):- (Optional)</strong></font>  <p><font size="2">-----------------------------------------------------------------</font>  <p><font size="2">1) Open the PS windows &gt; Run this script as <strong>.\CertSetup.ps1 -Install.</strong></font>  <p><font size="2">CertSetup.ps1 script present inside the Service Fabric SDK folder in the directory C:\Program Files\Microsoft SDKs\Service Fabric\ClusterSetup\Secure. You can edit this file if you do not wanted certain things in that PS. </font> <p><font size="2">2) Export .cer to PFX</font>  <p><font color="#c0504d" size="2" face="Courier New">$pswd = ConvertTo-SecureString -String "1234" -Force –AsPlainText</font>  <p><font color="#c0504d" size="2" face="Courier New">Get-ChildItem -Path cert:\localMachine\my\&lt;Thumbprint&gt; | Export-PfxCertificate -FilePath C:\mypfx.pfx -Password $pswd</font><font color="#c0504d" size="2" face="Courier New"></font></p> <p><font size="2"><strong>Precaution</strong>:- </font> <ol> <li><font size="2">How to: Retrieve the Thumbprint of a Certificate<br></font><a href="https://msdn.microsoft.com/en-us/library/ms734695(v=vs.110).aspx"><font size="2">https://msdn.microsoft.com/en-us/library/ms734695(v=vs.110).aspx</font></a></li> <li><font size="2">Remove the invisible chars in Thumbprint (User notepad++ &gt; Encoding &gt; Encode in ANSI to reveal the invisible chars) - Don't use Notepad. <a href="http://stackoverflow.com/questions/11115511/how-to-find-certificate-by-its-thumbprint-in-c-sharp">http://stackoverflow.com/questions/11115511/how-to-find-certificate-by-its-thumbprint-in-c-sharp</a> </font></li> <li><font size="2">Couple of </font><a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-for-windows-server"><font size="2">this</font></a><font size="2"> PS will help us to remove the cluster or clean the previous installation \RemoveServiceFabricCluster.ps1 &amp; .\CleanFabric.ps1 </font></li> <li><font size="2">Make sure to use PFX and not the cert. Just in case, i</font><font size="2">f you are run into some environment problem during dev stage, it is better to reimage and retry. </font></li></ol> <p><font size="2">Hope this helps. Let me know if you see/need change in this. </font>&nbsp;</p> <p><font size="2"></font>&nbsp; <p><font color="#c0504d" size="2" face="Courier New"></font><font color="#c0504d" size="2" face="Courier New"></font></div>
</div></body>
<script type='text/javascript' src='resource/jquery-1.12.1.min.js'></script>
<script type='text/javascript' src='resource/replace.js'></script>
</html>
