<html><head>
<meta charset='UTF-8'>
<link href='resource/bootstrap.min.css' rel='Stylesheet' type='text/css' />
<link href='resource/style.css' rel='Stylesheet' type='text/css' />
</head>
<body>
<div id='page'>
<h1 class='entry-title'>[Azure CDN] How to Purge CDN content from C# code</h1>
 <a class='url fn n profile-usercard-hover' href='https://social.msdn.microsoft.com/profile/Maheshk [MSFT]' target='_blank'>Maheshk [MSFT]</a>
<time>    4/1/2017 12:36:00 AM</time>
<hr>
<div id='content'><p><a title="https://blogs.msdn.microsoft.com/gianlucb/2016/01/18/azure-usage-of-cdn-api-to-load-and-purge-content/" href="https://blogs.msdn.microsoft.com/gianlucb/2016/01/18/azure-usage-of-cdn-api-to-load-and-purge-content/"><font color="#000000">Recently I had a chance to work</font></a> on this ask where one of the developer wanted a sample code to purge the CDN content by hitting <a href="https://docs.microsoft.com/en-us/rest/api/cdn/endpoints#Endpoints_PurgeContent"><strong><u>this</u></strong></a> REST API instead portal. Initially I followed this <a href="https://blogs.msdn.microsoft.com/gianlucb/2016/01/18/azure-usage-of-cdn-api-to-load-and-purge-content/"><u>link</u></a> but do not wanted to give my username and password as explained there for AAD authentication. I wanted to get my app registered with AAD as WebApp and then work with ClientID and Client Secret way to the get the bearer token for making the REST API call. It worked rightly after so many attempts, so would like to leave the steps here for easy reference. </p> <p><strong>Step1</strong>: Register your Web Application in AAD (portal.Azure.com) and get the Client ID and Secret generated. </p> <p><a href="media/2017/04/8.jpg"><img title="8" style="border-left-width: 0px;border-right-width: 0px;border-bottom-width: 0px;padding-top: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px" border="0" alt="8" src="media/2017/04/8_thumb.jpg" width="538" height="376"></a></p> <p><strong>Step2</strong>) Select the required permissions as below. </p> <p><a href="media/2017/04/7.jpg"><img title="7" style="border-left-width: 0px;border-right-width: 0px;border-bottom-width: 0px;padding-top: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px" border="0" alt="7" src="media/2017/04/7_thumb.jpg" width="936" height="253"></a></p> <p><a href="media/2017/04/6.jpg"><img title="6" style="border-left-width: 0px;border-right-width: 0px;border-bottom-width: 0px;padding-top: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px" border="0" alt="6" src="media/2017/04/6_thumb.jpg" width="607" height="278"></a></p> <p><strong>Step3) </strong>Add this application as a contributor to the CDN Endpoint which we wanted to purge. </p> <p>CDN Profile &gt; CDN Endpoint &gt; Access Control (IAM) &gt; Add our Web Application which is going to hit this endpoint to purge</p> <p><strong><a href="media/2017/04/10.jpg"><img title="10" style="border-left-width: 0px;border-right-width: 0px;border-bottom-width: 0px;padding-top: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px" border="0" alt="10" src="media/2017/04/10_thumb.jpg" width="935" height="450"></a></strong></p> <p><strong><a href="media/2017/04/9.jpg"><img title="9" style="border-left-width: 0px;border-right-width: 0px;border-bottom-width: 0px;padding-top: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px" border="0" alt="9" src="media/2017/04/9_thumb.jpg" width="939" height="312"></a></strong></p> <p><strong>Step4) </strong>Now run our sample code to get invoke purged call </p> <p><a href="media/2017/04/image.png"><img title="image" style="border-left-width: 0px;border-right-width: 0px;border-bottom-width: 0px;padding-top: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px" border="0" alt="image" src="media/2017/04/image_thumb.png" width="932" height="468"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </p> <p><font color="#0000ff"><font color="#000000"><strong>Step5)</strong> On success.</font> </font></p> <p><font color="#0000ff"><a href="media/2017/04/5.jpg"><img title="5" style="border-left-width: 0px;border-right-width: 0px;border-bottom-width: 0px;padding-top: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px" border="0" alt="5" src="media/2017/04/5_thumb.jpg" width="780" height="350"></a></font></p> <p><font color="#0000ff"><strong><u>Sample C# code used for purge ( from WebApplication ) </u></strong></font></p> <p><font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public ActionResult Contact()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetAccessTokenAndMakePurgeCall();</font></p> <p><font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ViewBag.Result = "Done - Purged all.. ";</font></p> <p><font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return View();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></p> <p><font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static void GetAccessTokenAndMakePurgeCall()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string clientId = "e32a947c-136e-xxxxxx-15eed998b592";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string clientSecret = "Ga9y3/9wNklz3Ft/xxxxxxxxgqpNM5KZxxxXM=";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string uri = @"</font><a href="https://management.azure.com/subscriptions/xxxxxx-xxxxx/resourcegroups/emptybincdnrg/providers/Microsoft.Cdn/profiles/bluehousecdn/endpoints/bhep/purge?api-version=2015-06-01&quot;;"><font color="#0000ff">https://management.azure.com/subscriptions/xxxxxx-xxxxx/resourcegroups/emptybincdnrg/providers/Microsoft.Cdn/profiles/bluehousecdn/endpoints/bhep/purge?api-version=2015-06-01";</font></a></p> <p><font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var authenticationContext = new AuthenticationContext("</font><a href="https://login.microsoftonline.com/microsoft.onmicrosoft.com&quot;);"><font color="#0000ff">https://login.microsoftonline.com/microsoft.onmicrosoft.com");</font></a><br><font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ClientCredential clientCredential = new ClientCredential(clientId, clientSecret);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Task&lt;AuthenticationResult&gt; resultstr = authenticationContext.AcquireTokenAsync("</font><a href="https://management.core.windows.net/&quot;"><font color="#0000ff">https://management.core.windows.net/"</font></a><font color="#0000ff">, clientCredential);</font></p> <p><font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WebClient client = new WebClient();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //authentication using the Azure AD application<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var token = resultstr.Result.AccessToken;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; client.Headers.Add(HttpRequestHeader.Authorization, "Bearer " + token);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; client.Headers.Add("api-version:2015-06-01");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; client.Headers.Add("Content-Type", "application/json");</font></p> <p><font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var bodyText = string.Empty;</font></p> <p><font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font style="background-color: #ffff00">//For individual files<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //dynamic content = new { ContentPaths = new List&lt;string&gt;() { "/1.jpg", "/2.jpg" } };</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //bodyText = JsonConvert.SerializeObject(content);</font></p> <p><font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //For purge all (*.*)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //<font style="background-color: #ffff00">bodyText = "{\"ContentPaths\":[\"/*\"]}";</font></font></p> <p><font color="#0000ff">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <font style="background-color: #ffff00">&nbsp;&nbsp;&nbsp; var result = client.UploadString(uri, bodyText);</font><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch (Exception ew)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //handle the exception here<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></p> <p><font color="#0000ff"></font>&nbsp;</p> <p><font color="#000000">On running fiddler, we can see the header details are formed correctly and getting the bearer token to proceed. </font></p> <p><font color="#c0504d" face="Courier New"></font></p> <p><a href="media/2017/04/image1.png"><img title="image" style="border-left-width: 0px;border-right-width: 0px;border-bottom-width: 0px;padding-top: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px" border="0" alt="image" src="media/2017/04/image_thumb1.png" width="907" height="449"></a></p> <p>On success, you could see “<font style="background-color: #ffff00">202</font>” in the response which means our purge request has been accepted. </p> <p><a href="media/2017/04/image2.png"><img title="image" style="border-left-width: 0px;border-right-width: 0px;border-bottom-width: 0px;padding-top: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px" border="0" alt="image" src="media/2017/04/image_thumb2.png" width="912" height="394"></a></p> <p> <p>&nbsp;</p> <p>&lt;update:4/18&gt;</p> <p><strong>How to purge the CDN content using Postman ( assuming you have the valid bearer token )</strong></p> <p><a href="media/2017/04/111.jpg"><img title="1" style="border-left-width: 0px;border-right-width: 0px;border-bottom-width: 0px;padding-top: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px" border="0" alt="1" src="media/2017/04/1_thumb.jpg" width="1037" height="405"></a></p> <p><a href="media/2017/04/23.jpg"><img title="2" style="border-left-width: 0px;border-right-width: 0px;border-bottom-width: 0px;padding-top: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px" border="0" alt="2" src="media/2017/04/2_thumb.jpg" width="1041" height="372"></a></p> <p>On success, you would see “202” – accepted. </p> <p>&lt;/update&gt;</p> <p>Hope this helps. </p> <p>&nbsp;</p> <p><font style="background-color: #ffff00"><font color="#ff0000" size="2">&lt;Disclaimer&gt;&nbsp; </font></font></p> <p><font style="background-color: #ffff00" color="#ff0000" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; a) This sample code provided here is for the purpose of illustration only and is not intended to be used in a production environment as it is. </font></p> <p><font style="background-color: #ffff00" color="#ff0000" size="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; b) ContentPaths should be carefully checked. The path “/*” should be used <strong><u>only</u></strong> when you want to purge all the contents otherwise specify the resource path.</font></p> <p><font style="background-color: #ffff00"><font color="#ff0000"><font color="#ff0000" size="2">&lt;/Disclaimer&gt;</font>&nbsp; </font></font></p></div>
</div></body>
<script type='text/javascript' src='resource/jquery-1.12.1.min.js'></script>
<script type='text/javascript' src='resource/replace.js'></script>
</html>
