<html><head>
<meta charset='UTF-8'>
<link href='resource/bootstrap.min.css' rel='Stylesheet' type='text/css' />
<link href='resource/style.css' rel='Stylesheet' type='text/css' />
</head>
<body>
<div id='page'>
<h1 class='entry-title'>[Azure Service Fabric] Use of EnableDefaultServicesUpgrade property</h1>
 <a class='url fn n profile-usercard-hover' href='https://social.msdn.microsoft.com/profile/Maheshk [MSFT]' target='_blank'>Maheshk [MSFT]</a>
<time>    5/24/2017 1:20:00 AM</time>
<hr>
<div id='content'><p>Recently I had this issue where Service Fabric application upgrade fails to deploy as expected after changing the instance count in cloud.xml. Here is what I tried and error received. </p> <p><strong>problem:-</strong></p> <ol> <li>Create a stateless project with latest Azure Service fabric sdk 5.5  <li>Deploy first with Stateless1_InstanceCount set to –1&nbsp; (default) <li>Now set Stateless1_InstanceCount to say <strong>2</strong> from cloud.xml and redeploy with upgrade option checked </li></ol> <p>While publishing this upgrade from visual studio, I saw a property value expected to be “true” but no clue at initial glance. </p> <p><strong>Visual studio error:-</strong></p> <p><font color="#c0504d"><font size="2" face="Courier New">1&gt;------ Build started: Project: Application3, Configuration: Debug x64 ------<br>2&gt;------ Publish started: Project: Application3, Configuration: Debug x64 ------<br>2&gt;Started executing script 'GetApplicationExistence'.<br>2&gt;Finished executing script 'GetApplicationExistence'.<br>2&gt;Time elapsed: 00:00:01.5800095<br>-------- Package started: Project: Application3, Configuration: Debug x64 ------<br>Application3 -&gt; D:\Cases\_Code\Application3\Application3\pkg\Debug<br>-------- Package: Project: Application3 succeeded, Time elapsed: 00:00:00.7978341 --------<br>2&gt;Started executing script 'Deploy-FabricApplication.ps1'.<br>2&gt;. 'D:\Cases\_Code\Application3\Application3\Scripts\Deploy-FabricApplication.ps1' -ApplicationPackagePath 'D:\Cases\_Code\Application3\Application3\pkg\Debug' -PublishProfileFile 'D:\Cases\_Code\Application3\Application3\PublishProfiles\Cloud.xml' -DeployOnly:$false -ApplicationParameter:@{} -UnregisterUnusedApplicationVersionsAfterUpgrade $false -OverrideUpgradeBehavior 'None' -OverwriteBehavior 'SameAppTypeAndVersion' -SkipPackageValidation:$false -ErrorAction Stop<br>2&gt;Copying application package to image store...<br>2&gt;Copy application package succeeded<br>2&gt;Registering application type...<br>2&gt;Register application type succeeded<br>2&gt;Start upgrading application...<br>2&gt;Unregister application type '@{FabricNamespace=fabric:; ApplicationTypeName=Application3Type; ApplicationTypeVersion=1.1.0}.ApplicationTypeName' and version '@{FabricNamespace=fabric:; ApplicationTypeName=Application3Type; ApplicationTypeVersion=1.1.0}.ApplicationTypeVersion' ...<br>2&gt;Unregister application type started (query application types for status).<br>2&gt;Start-ServiceFabricApplicationUpgrade : Default service descriptions can not be modified as part of upgrade. <br><font style="background-color: #ffff00"><font style="background-color: #ffffff">2&gt;Modified default service: fabric:/Application3/Stateless1.</font> To allow it, set EnableDefaultServicesUpgrade to true.</font><br>2&gt;At C:\Program Files\Microsoft SDKs\Service <br>2&gt;Fabric\Tools\PSModule\ServiceFabricSDK\Publish-UpgradedServiceFabricApplication.ps1:248 char:13<br>2&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Start-ServiceFabricApplicationUpgrade @UpgradeParameters<br>2&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~<br>2&gt;&nbsp;&nbsp;&nbsp; + CategoryInfo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : InvalidOperation: (Microsoft.Servi...usterConnection:ClusterConnection) [Start-Servi <br>2&gt;&nbsp;&nbsp; ceFabricApplicationUpgrade], FabricException<br>2&gt;&nbsp;&nbsp;&nbsp; + FullyQualifiedErrorId : UpgradeApplicationErrorId,Microsoft.ServiceFabric.Powershell.StartApplicationUpgrade<br>2&gt; <br>2&gt;Finished executing script 'Deploy-FabricApplication.ps1'.<br>2&gt;Time elapsed: 00:00:22.5520036<br>2&gt;The PowerShell script failed to execute.<br>========== Build: 1 succeeded, 0 failed, 1 up-to-date, 0 skipped ==========<br>========== Publish: 0 succeeded, 1 failed, 0 skipped ==========</font></font></p> <p>Upon searching in our internal discussion forum, I noticed this property needs an update from resources.azure.com or through PS. </p> <p>By default, we would be having this property set to “-1” in cloud.xml or application manifest xml. The value “-1” is default and it deploys to <strong><u>all</u></strong> available nodes. At situation, we&nbsp; may need to reduce the instance count, so if that this is the case follow any of the option. </p> <p><strong><u>Option # 1 ( Update through resources.azure.com portal )</u></strong></p> <p>1) From the error message it is clear that, sf cluster expects a property “<em>EnableDefaultServicesUpgrade” </em>to be set it <strong>true </strong>to proceed this upgrade. </p> <p>2) This link talks about adding sf cluster settings from resources.azure.com portal - <a title="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-fabric-settings" href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-fabric-settings">https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-fabric-settings</a>&nbsp; ( refer the steps at the top of the page). </p> <p>3) Update your cluster settings as below and wait for atleast 30-40 mins depends on the number of nodes etc. </p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="media/2017/05/werer.png"><img title="werer" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="werer" src="media/2017/05/werer_thumb.png" width="874" height="555"></a></p> <p>4) After this PUT command, you would see a small banner message saying upgrading cluster in Portal.azure.com &gt; sf cluster overview page blade. </p> <p>5) Wait till the upgrade banner goes away so that you can run the GET command from resources.azure.com to confirm this value is reflecting or not. </p> <p><strong><u>Option#2: ( update through&nbsp; PS )</u></strong></p> <p>You can use the below PS to update this value. </p> <p><font color="#c0504d" face="Courier New">$ClusterName= "&lt;your client connection endpoint &gt; eg. abc.westus.cloudapp.azure.com:19000"</font></p> <p><font color="#c0504d" face="Courier New">$Certthumprint = "xxxxxx5a813118ef9cf523a4df13d"</font> <p><font color="#c0504d" face="Courier New"><strong>Connect-serviceFabricCluster</strong> -ConnectionEndpoint $ClusterName -KeepAliveIntervalInSec 10 `</font> <p><font color="#c0504d" face="Courier New">-X509Credential `</font> <p><font color="#c0504d" face="Courier New">-ServerCertThumbprint $Certthumprint&nbsp; `</font> <p><font color="#c0504d" face="Courier New">-FindType FindByThumbprint `</font> <p><font color="#c0504d" face="Courier New">-FindValue $Certthumprint `</font> <p><font color="#c0504d" face="Courier New">-StoreLocation CurrentUser `</font> <p><font color="#c0504d" face="Courier New">-StoreName My</font> <p><a href="https://docs.microsoft.com/en-us/powershell/module/servicefabric/update-servicefabricservice" target="_blank"><font color="#c0504d" face="Courier New"><strong>Update-ServiceFabricService</strong></font></a><font color="#c0504d" face="Courier New"> -Stateless fabric:/KeyPair.WebService/KeyPairAPI -InstanceCount 2</font> <p><a title="https://docs.microsoft.com/en-us/powershell/module/servicefabric/update-servicefabricservice?view=azureservicefabricps" href="https://docs.microsoft.com/en-us/powershell/module/servicefabric/update-servicefabricservice?view=azureservicefabricps">https://docs.microsoft.com/en-us/powershell/module/servicefabric/update-servicefabricservice?view=azureservicefabricps</a>&nbsp;</p> <p><strong>Final step:-</strong></p> <p>After the settings update, now go back to Visual Studio (2017) and try publishing app upgrade. At this point, we should see application getting deployed without any error. </p> <p>You can confirm this by checking the number of node where this app is deployed. From the service fabric explorer (SFX) portal, you could see our application deployed just in 2 nodes instead all the available nodes.&nbsp; </p> <p>I had 3 node cluster where I set the instance count to 2 to see the application reduction. </p> <p><em>Note:- The only caveat here is, we won’t be seeing the SFX portal manifest having this latest instance count value reflected. It would still show “-1” which you can ignore. </em></p></div>
</div></body>
<script type='text/javascript' src='resource/jquery-1.12.1.min.js'></script>
<script type='text/javascript' src='resource/replace.js'></script>
</html>
