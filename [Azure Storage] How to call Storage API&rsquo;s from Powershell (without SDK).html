<html><head>
<meta charset='UTF-8'>
<link href='resource/bootstrap.min.css' rel='Stylesheet' type='text/css' />
<link href='resource/style.css' rel='Stylesheet' type='text/css' />
</head>
<body>
<div id='page'>
<h1 class='entry-title'>[Azure Storage] How to call Storage API&rsquo;s from Powershell (without SDK)</h1>
 <a class='url fn n profile-usercard-hover' href='https://social.msdn.microsoft.com/profile/Maheshk [MSFT]' target='_blank'>Maheshk [MSFT]</a>
<time>    4/6/2017 10:10:00 PM</time>
<hr>
<div id='content'><!-- /* Font Definitions */ @font-face {font-family:"Cambria Math"; panose-1:2 4 5 3 5 4 6 3 2 4;} @font-face {font-family:calibri; panose-1:2 15 5 2 2 2 4 3 2 4;} @font-face {font-family:"Lucida Console"; panose-1:2 11 6 9 4 5 4 2 2 4;} /* Style Definitions */ p.msonormal, li.msonormal, div.msonormal {margin-top:0in; margin-right:0in; margin-bottom:8.0pt; margin-left:0in; line-height:107%; font-size:11.0pt; font-family:"Calibri",sans-serif;} .msochpdefault {font-family:"Calibri",sans-serif;} .msopapdefault {margin-bottom:8.0pt; line-height:107%;} @page wordsection1 {size:8.5in 11.0in; margin:1.0in 1.0in 1.0in 1.0in;} div.wordsection1 {page:wordsection1;} -->
<div class="WordSection1">
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span style="font-size: small">Recently I had this ask from a partner who wanted sample code for making REST API call to storage without our SDK’s route. Though we have array of SDK’s supporting many languages, still he wanted to make clean REST calls without SDK’s. It some time to understand and create this proof of concept. So sharing here to easy reference. Hope this helps in some way.. </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$accountname</span><span>=</span><span>"your_storage_accname"</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$key</span><span> <span style="color: darkgray">=</span> <span style="color: darkred">"acc_key"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$container</span><span>=</span><span>"container_name"</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>#file to create</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$blkblob</span><span>=</span><span>"samplefile.log"</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$f</span><span> <span style="color: darkgray">=</span> <span style="color: darkred">"C:\\temp\\samplefile.log"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$BlobOperation</span><span> <span style="color: darkgray">=</span> <span style="color: darkred">"<span style="background-color: #ffff00">PUT</span>"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$body</span><span> <span style="color: darkgray">=</span> (<span style="color: blue">Get-Content</span> <span style="color: navy">-Path</span> <span style="color: orangered">$f</span> <span style="color: navy">-Raw</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><del><span>$filelen</span><span> <span style="color: darkgray">=</span> <span style="color: orangered">$body</span><span style="color: darkgray">.</span>Length
</span></del></p>
#added this per comments in the below blog post.

$filelen = (Get-ChildItem -File $f).Length
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RESTAPI_URL</span><span> <span style="color: darkgray">=</span> <span style="color: darkred">"https://</span><span style="color: orangered">$accountname</span><span style="color: darkred">.blob.core.windows.net/</span><span style="color: orangered">$container</span><span style="color: darkred">/</span><span style="color: orangered">$blkblob</span><span style="color: darkred">"</span>;</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$date</span><span>=</span><span>(<span style="color: blue">Get-Date</span>)<span style="color: darkgray">.</span>ToUniversalTime()</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$datestr</span><span>=</span><span>$date</span><span>.</span><span>ToString(<span style="color: darkred">"R"</span>);</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$datestr2</span><span>=</span><span>$date</span><span>.</span><span>ToString(<span style="color: darkred">"s"</span>)<span style="color: darkgray">+</span><span style="color: darkred">"Z"</span>;</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$strtosign</span><span> <span style="color: darkgray">=</span> <span style="color: darkred">"</span><span style="color: orangered">$BlobOperation</span><span style="color: darkred">`n`n`n</span><span style="color: orangered">$filelen</span><span style="color: darkred">`n`n`n`n`n`n`n`n`nx-ms-blob-type:BlockBlob`nx-ms-date:</span><span style="color: orangered">$datestr</span><span style="color: darkred">`nx-ms-version:2015-04-05`n/"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$strtosign</span><span> <span style="color: darkgray">=</span> <span style="color: orangered">$strtosign</span> <span style="color: darkgray">+</span> <span style="color: orangered">$accountname</span> <span style="color: darkgray">+</span> <span style="color: darkred">"/"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$strtosign</span><span> <span style="color: darkgray">=</span> <span style="color: orangered">$strtosign</span> <span style="color: darkgray">+</span> <span style="color: orangered">$container</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$strtosign</span><span> <span style="color: darkgray">=</span> <span style="color: orangered">$strtosign</span> <span style="color: darkgray">+</span> <span style="color: darkred">"/"</span> <span style="color: darkgray">+</span><span style="color: orangered">$blkblob</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>write-host</span><span> <span style="color: orangered">$strtosign</span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>[</span><span>byte</span><span>[]]</span><span>$dataBytes</span><span> <span style="color: darkgray">=</span> (<span style="color: darkgray">[</span><span style="color: teal">System.Text.Encoding</span><span style="color: darkgray">]::</span>UTF8)<span style="color: darkgray">.</span>GetBytes(<span style="color: orangered">$strtosign</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$hmacsha256</span><span> <span style="color: darkgray">=</span> <span style="color: blue">New-Object</span> <span style="color: blueviolet">System.Security.Cryptography.HMACSHA256</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$hmacsha256</span><span>.</span><span>Key <span style="color: darkgray">=</span> <span style="color: darkgray">[</span><span style="color: teal">Convert</span><span style="color: darkgray">]::</span>FromBase64String(<span style="color: orangered">$key</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$sig</span><span> <span style="color: darkgray">=</span> <span style="color: darkgray">[</span><span style="color: teal">Convert</span><span style="color: darkgray">]::</span>ToBase64String(<span style="color: orangered">$hmacsha256</span><span style="color: darkgray">.</span>ComputeHash(<span style="color: orangered">$dataBytes</span>))</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$authhdr</span><span> <span style="color: darkgray">=</span> <span style="color: darkred">"SharedKey </span><span style="color: orangered">$accountname</span><span style="color: darkred">`:</span><span style="color: orangered">$sig</span><span style="color: darkred">"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>write-host</span><span> <span style="color: orangered">$authhdr</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RequestHeader</span><span> <span style="color: darkgray">=</span> <span style="color: blue">New-Object</span> <span style="color: darkred">"System.Collections.Generic.Dictionary[[String],[String]]"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RequestHeader</span><span>.</span><span>Add(<span style="color: darkred">"Authorization"</span><span style="color: darkgray">,</span> <span style="color: orangered">$authhdr</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RequestHeader</span><span>.</span><span>Add(<span style="color: darkred">"x-ms-date"</span><span style="color: darkgray">,</span> <span style="color: orangered">$datestr</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RequestHeader</span><span>.</span><span>Add(<span style="color: darkred">"x-ms-version"</span><span style="color: darkgray">,</span> <span style="color: darkred">"2015-04-05"</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RequestHeader</span><span>.</span><span>Add(<span style="color: darkred">"x-ms-blob-type"</span><span style="color: darkgray">,</span><span style="color: darkred">"BlockBlob"</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>#create a new PS object to hold the response JSON</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RESTResponse</span><span> <span style="color: darkgray">=</span> <span style="color: blue">New-Object</span> <span style="color: blueviolet">PSObject</span>;</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RESTResponse</span><span> <span style="color: darkgray">=</span> (<span style="color: blue">Invoke-RestMethod</span> <span style="color: navy">-Uri</span> <span style="color: orangered">$RESTAPI_URL</span> <span style="color: navy">-Method</span> <span style="color: blueviolet">put</span> <span style="color: navy">-Headers</span> <span style="color: orangered">$RequestHeader</span> <span style="color: navy">-InFile</span> <span style="color: orangered">$f</span>);</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>write-host</span><span> <span style="color: orangered">$RESTResponse</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>write-host</span><span> <span style="color: darkred">"# Success !!! uploaded the file &gt;&gt;"</span> <span style="color: orangered">$RESTAPI_URL</span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span></span></p>
<p class="MsoNormal"><strong>-------------------------------------------------------------------------------------------------------------------------------------------------------------</strong></p>

</div>
<div class="WordSection1">
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$accountname</span><span>=</span><span>"your_storage_accname"</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$key</span><span> <span style="color: darkgray">=</span> <span style="color: darkred">"acc_key"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$container</span><span>=</span><span>"container_name"</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$blkblob</span><span>=</span><span>"file_for_deletion"</span><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$BlobOperation</span><span> <span style="color: darkgray">=</span> <span style="color: darkred">"<span style="background-color: #ffff00">DELETE</span>"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RESTAPI_URL</span><span> <span style="color: darkgray">=</span> <span style="color: darkred">"https://</span><span style="color: orangered">$accountname</span><span style="color: darkred">.blob.core.windows.net/</span><span style="color: orangered">$container</span><span style="color: darkred">/</span><span style="color: orangered">$blkblob</span><span style="color: darkred">"</span>;</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$date</span><span>=</span><span>(<span style="color: blue">Get-Date</span>)<span style="color: darkgray">.</span>ToUniversalTime()</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$datestr</span><span>=</span><span>$date</span><span>.</span><span>ToString(<span style="color: darkred">"R"</span>);</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$datestr2</span><span>=</span><span>$date</span><span>.</span><span>ToString(<span style="color: darkred">"s"</span>)<span style="color: darkgray">+</span><span style="color: darkred">"Z"</span>;</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$strtosign</span><span> <span style="color: darkgray">=</span> <span style="color: darkred">"</span><span style="color: orangered">$BlobOperation</span><span style="color: darkred">`n`n`n`n`n`n`n`n`n`n`n`nx-ms-blob-type:BlockBlob`nx-ms-date:</span><span style="color: orangered">$datestr</span><span style="color: darkred">`nx-ms-version:2015-04-05`n/"</span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$strtosign</span><span> <span style="color: darkgray">=</span> <span style="color: orangered">$strtosign</span> <span style="color: darkgray">+</span> <span style="color: orangered">$accountname</span> <span style="color: darkgray">+</span> <span style="color: darkred">"/"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$strtosign</span><span> <span style="color: darkgray">=</span> <span style="color: orangered">$strtosign</span> <span style="color: darkgray">+</span> <span style="color: orangered">$container</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$strtosign</span><span> <span style="color: darkgray">=</span> <span style="color: orangered">$strtosign</span> <span style="color: darkgray">+</span> <span style="color: darkred">"/"</span> <span style="color: darkgray">+</span><span style="color: orangered">$blkblob</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>write-host</span><span> <span style="color: orangered">$strtosign</span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>[</span><span>byte</span><span>[]]</span><span>$dataBytes</span><span> <span style="color: darkgray">=</span> (<span style="color: darkgray">[</span><span style="color: teal">System.Text.Encoding</span><span style="color: darkgray">]::</span>UTF8)<span style="color: darkgray">.</span>GetBytes(<span style="color: orangered">$strtosign</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$hmacsha256</span><span> <span style="color: darkgray">=</span> <span style="color: blue">New-Object</span> <span style="color: blueviolet">System.Security.Cryptography.HMACSHA256</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$hmacsha256</span><span>.</span><span>Key <span style="color: darkgray">=</span> <span style="color: darkgray">[</span><span style="color: teal">Convert</span><span style="color: darkgray">]::</span>FromBase64String(<span style="color: orangered">$key</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$sig</span><span> <span style="color: darkgray">=</span> <span style="color: darkgray">[</span><span style="color: teal">Convert</span><span style="color: darkgray">]::</span>ToBase64String(<span style="color: orangered">$hmacsha256</span><span style="color: darkgray">.</span>ComputeHash(<span style="color: orangered">$dataBytes</span>))</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$authhdr</span><span> <span style="color: darkgray">=</span> <span style="color: darkred">"SharedKey </span><span style="color: orangered">$accountname</span><span style="color: darkred">`:</span><span style="color: orangered">$sig</span><span style="color: darkred">"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>write-host</span><span> <span style="color: orangered">$authhdr</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RequestHeader</span><span> <span style="color: darkgray">=</span> <span style="color: blue">New-Object</span> <span style="color: darkred">"System.Collections.Generic.Dictionary[[String],[String]]"</span></span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RequestHeader</span><span>.</span><span>Add(<span style="color: darkred">"Authorization"</span><span style="color: darkgray">,</span> <span style="color: orangered">$authhdr</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RequestHeader</span><span>.</span><span>Add(<span style="color: darkred">"x-ms-date"</span><span style="color: darkgray">,</span> <span style="color: orangered">$datestr</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RequestHeader</span><span>.</span><span>Add(<span style="color: darkred">"x-ms-version"</span><span style="color: darkgray">,</span> <span style="color: darkred">"2015-04-05"</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RequestHeader</span><span>.</span><span>Add(<span style="color: darkred">"x-ms-blob-type"</span><span style="color: darkgray">,</span><span style="color: darkred">"BlockBlob"</span>)</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RESTResponse</span><span> <span style="color: darkgray">=</span> <span style="color: blue">New-Object</span> <span style="color: blueviolet">PSObject</span>;</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>write-host</span><span> <span style="color: orangered">$RESTAPI_URL</span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>$RESTResponse</span><span> <span style="color: darkgray">=</span> (<span style="color: blue">Invoke-RestMethod</span> <span style="color: navy">-Uri</span> <span style="color: orangered">$RESTAPI_URL</span> <span style="color: navy">-Method</span> <span style="color: blueviolet">Delete</span> <span style="color: navy">-Headers</span> <span style="color: orangered">$RequestHeader</span>);</span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span> </span></p>
<p class="MsoNormal" style="margin-bottom: 0pt;background: white;line-height: normal"><span>write-host</span><span> <span style="color: darkred">"# Success !!! deleted the input file &gt;&gt;"</span> <span style="color: orangered">$RESTAPI_URL </span></span></p>
<p class="MsoNormal"><strong><span style="font-size: small"><u></u></span></strong></p>
<p class="MsoNormal"><strong><span style="font-size: small"><u>reference:-</u></span></strong></p>
<p class="MsoNormal"><a href="https://dzone.com/articles/examples-windows-azure-storage" title="https://dzone.com/articles/examples-windows-azure-storage"><span style="font-size: medium">https://dzone.com/articles/examples-windows-azure-storage</span></a></p>
<p class="MsoNormal"><a href="https://docs.microsoft.com/en-us/azure/storage/storage-introduction#storage-apis-libraries-and-tools"><span style="font-size: medium">https://docs.microsoft.com/en-us/azure/storage/storage-introduction#storage-apis-libraries-and-tools</span></a></p>

</div></div>
</div></body>
<script type='text/javascript' src='resource/jquery-1.12.1.min.js'></script>
<script type='text/javascript' src='resource/replace.js'></script>
</html>
