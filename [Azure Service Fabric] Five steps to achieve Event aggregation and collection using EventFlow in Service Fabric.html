<html><head>
<meta charset='UTF-8'>
<link href='resource/bootstrap.min.css' rel='Stylesheet' type='text/css' />
<link href='resource/style.css' rel='Stylesheet' type='text/css' />
</head>
<body>
<div id='page'>
<h1 class='entry-title'>[Azure Service Fabric] Five steps to achieve Event aggregation and collection using EventFlow in Service Fabric</h1>
 <a class='url fn n profile-usercard-hover' href='https://social.msdn.microsoft.com/profile/Maheshk [MSFT]' target='_blank'>Maheshk [MSFT]</a>
<time>    7/11/2017 10:50:00 PM</time>
<hr>
<div id='content'><p>Monitoring and diagnostic are critical part in application development for diagnosing issue at production or development time. It helps one to easily identify any application issue, h/w issue and performance data to guide scope for improvement. It has 3 part workflow starts with 1) Event Generation 2) Event Aggregation 3) Analysis. </p><p>1) Event Generation –&gt; creation and generation of events &amp; logs. Logs could be of <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-diagnostics-event-generation-infra" target="_blank">infra</a> level events(anything from the cluster) or <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-diagnostics-event-generation-app" target="_blank">application</a> level events (from the apps and services). </p><p>2) Event Aggregation –&gt; generated events needs to be collated and aggregated before they can be displayed</p><p>3) Analysis –&gt; visualized in some format</p><p><br></p><p>Once we decide the log provider, the next phase is aggregation. In Service Fabric, the event aggregation can be achieved by using <strong>(a) </strong><font><strong>Azure Diagnostic logs</strong> <strong>(agent installed on VM’s</strong></font>) or <strong>(b) <font>EventFlow (in process log collection).</font></strong> </p><p>Agent based log collection is a good option if our event source and destination does not change and have one to one mapping. Any change would require cluster level update which is sometime tedious and time consuming. In this type, the logs get tanked in storage and then goes to display phase. </p><p>But in case of EventFlow, in process logs are directly thrown to a remote service visualizer. Changing the data destination doesn’t require any cluster level changes as like in agent way update. Anytime we can change the data destination path from this file <em>eventFlowConfig.json. </em>Depends on the criticality we can have both if required. However, Azure diagnostics logs are recommended for mostly infra level log collection where as EventFlow suggested for Application level logs. The last step is Event Analysis where we analysis and visualize the incoming data. Azure Service fabric has better integration support for <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-diagnostics-event-analysis-oms" target="_blank">OMS</a> and <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-diagnostics-event-analysis-appinsights" target="_blank">Application Insights</a>. </p><p><br></p><p>In this article, let us see how one can easily use EventFlow in their Service Fabric Stateful application in 5 steps. </p><p><strong>Step1:-</strong> Let say, create a new Service Fabric Project by selecting “Stateful Service” application. Pls change the .NET version of the project to 4.6 and above. </p><p><strong>Step2:-</strong> Right click and add the following nuget packages. Search for "Diagnostics.EventFlow" and then add the following packages.&nbsp; <br></p><p>&nbsp;&nbsp;&nbsp; Microsoft.Diagnostics.EventFlow.ServiceFabric<br>&nbsp;&nbsp;&nbsp; Microsoft.Diagnostics.EventFlow.Outputs.ApplicationInsights<br>&nbsp;&nbsp;&nbsp; Microsoft.Diagnostics.EventFlow.Input.EventSource</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="media/2017/07/image177.png"><img width="644" height="492" title="image" alt="image" src="media/2017/07/image_thumb155.png" border="0"></a></p><p><strong>Step3:-</strong> Update the <em><font>eventflowconfig.json</font></em> file as below. Event Source class uses the Json file to send the data. This file needs to be modified to capture data or configure to desired destination. </p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="media/2017/07/image178.png"><img width="734" height="522" title="image" alt="image" src="media/2017/07/image_thumb156.png" border="0"></a></p><p><strong>Step4:</strong> Update the “ServiceEventSource.cs” class.&nbsp; We need a name of Service’s ServiceEventSource is the value of the attribute set for this class.&nbsp;&nbsp; </p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="media/2017/07/image179.png"><img width="737" height="456" title="image" alt="image" src="media/2017/07/image_thumb157.png" border="0"></a></p><p><strong>Step5:-</strong> Instantiate the EventFlow pipeline in our service startup code and start writing the service message. </p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="media/2017/07/image180.png"><img width="797" height="394" title="image" alt="image" src="media/2017/07/image_thumb158.png" border="0"></a></p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="media/2017/07/image181.png"><img width="800" height="342" title="image" alt="image" src="media/2017/07/image_thumb159.png" border="0"></a></p><p>Deploy the application and confirm all green and no issue with deployment or any dependency issue. </p><p><a href="media/2017/07/image182.png"><img width="783" height="488" title="image" alt="image" src="media/2017/07/image_thumb160.png" border="0"></a></p><p>To verify the trace logs, you can log into portal.azure.com &gt; your_application insights &gt; search and refresh (allow few mins to see the data flowing here )</p><p><a href="media/2017/07/image183.png"><img width="1157" height="485" title="image" alt="image" src="media/2017/07/image_thumb162.png" border="0"></a></p><p>Reference article:-</p><p><a title="https://github.com/Azure/diagnostics-eventflow" href="https://github.com/Azure/diagnostics-eventflow">https://github.com/Azure/diagnostics-eventflow</a></p><p><a title="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-diagnostics-event-aggregation-eventflow" href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-diagnostics-event-aggregation-eventflow">https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-diagnostics-event-aggregation-eventflow</a></p></div>
</div></body>
<script type='text/javascript' src='resource/jquery-1.12.1.min.js'></script>
<script type='text/javascript' src='resource/replace.js'></script>
</html>
